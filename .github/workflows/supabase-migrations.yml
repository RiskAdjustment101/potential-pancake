name: Deploy Supabase Migrations

on:
  push:
    branches: [main]
    paths:
      - 'supabase/migrations/**'
      - 'supabase/config.toml'
      - '.github/workflows/supabase-migrations.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Supabase client
        run: npm install @supabase/supabase-js

      - name: Run migrations via Supabase Management API
        env:
          SUPABASE_URL: https://lodmtemrzvmiihfoidrt.supabase.co
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ğŸš€ Deploying database migrations to Supabase..."
          
          # Create a Node.js script to run migrations
          cat > run-migrations.js << 'EOF'
          const { createClient } = require('@supabase/supabase-js');
          const fs = require('fs');
          const path = require('path');
          
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_KEY || process.env.SUPABASE_ANON_KEY;
          
          if (!supabaseUrl || !supabaseKey) {
            console.error('Missing Supabase credentials');
            process.exit(1);
          }
          
          const supabase = createClient(supabaseUrl, supabaseKey);
          
          async function runMigrations() {
            try {
              // Read migration file
              const migrationPath = path.join(__dirname, 'supabase/migrations/20240905000001_complete_setup.sql');
              const sql = fs.readFileSync(migrationPath, 'utf8');
              
              console.log('ğŸ“„ Running migration: 20240905000001_complete_setup.sql');
              console.log('This will create tables with RLS enabled...');
              
              // Note: For complex migrations, you might need to use the Supabase CLI
              // or run the SQL directly in the dashboard
              console.log('âš ï¸  Due to limitations, please run the migration manually:');
              console.log('1. Go to: https://supabase.com/dashboard/project/lodmtemrzvmiihfoidrt/sql');
              console.log('2. Copy and run the migration SQL');
              console.log('');
              console.log('Migration content preview:');
              console.log(sql.substring(0, 500) + '...');
              
            } catch (error) {
              console.error('Error:', error.message);
              process.exit(1);
            }
          }
          
          runMigrations();
          EOF
          
          node run-migrations.js

      - name: Alternative - Use Supabase CLI with Service Key
        if: always()
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          # Install Supabase CLI
          curl -L https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | tar xz
          sudo mv supabase /usr/local/bin/
          
          # Try to link and push
          supabase link --project-ref lodmtemrzvmiihfoidrt --password "${{ secrets.SUPABASE_DB_PASSWORD }}" || true
          supabase db push || true
          
          if [ $? -ne 0 ]; then
            echo "âš ï¸  Automated deployment requires manual setup"
            echo "Please run the migration manually in Supabase SQL Editor"
          fi